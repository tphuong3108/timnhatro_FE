import React, { useEffect, useState } from "react";
import {
  View,
  ActivityIndicator,
  Text,
  TouchableOpacity,
} from "react-native";
import { useLocalSearchParams, useRouter } from "expo-router";
import Animated, { FadeInDown } from "react-native-reanimated";
import { Ionicons } from "@expo/vector-icons";
import { profileApi } from "@/services/profileApi";

import InfoSection from "./InfoSection";
import ActionButtons from "./ActionButtons";
import CoverSection from "./CoverSection";
import MyPosts from "./MyPosts";
import Favorites from "./Favorites";

export default function UserProfile() {
  const { id } = useLocalSearchParams();
  const router = useRouter();

  const [user, setUser] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<"posts" | "favorites">("posts");

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        setError(null);

        console.log("üîç Fetching public profile for ID:", id);

        const data = await profileApi.getPublicProfile(id as string);

        console.log("üì¶ API Response:", data);

        setUser(data);
      } catch (err) {
        console.error("‚ùå L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:", err);
        setError("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng.");
      } finally {
        setLoading(false);
      }
    })();
  }, [id]);

  // üåÄ ƒêang t·∫£i
  if (loading) {
    return (
      <View className="flex-1 justify-center items-center bg-white">
        <ActivityIndicator size="large" color="#3F72AF" />
        <Text className="text-gray-500 mt-2">ƒêang t·∫£i th√¥ng tin...</Text>
      </View>
    );
  }

  // ‚ùå L·ªói khi t·∫£i
  if (error || !user) {
    return (
      <View className="flex-1 justify-center items-center bg-white px-6">
        <Ionicons name="alert-circle-outline" size={48} color="#999" />
        <Text className="text-gray-600 text-center mt-3">{error || "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng."}</Text>
        <TouchableOpacity
          onPress={() => router.back()}
          className="mt-5 bg-blue-500 px-5 py-2 rounded-full"
        >
          <Text className="text-white font-semibold">Quay l·∫°i</Text>
        </TouchableOpacity>
      </View>
    );
  }

  // ‚úÖ Hi·ªÉn th·ªã profile
  return (
    <Animated.ScrollView
      entering={FadeInDown.duration(500)}
      className="flex-1 bg-white"
      showsVerticalScrollIndicator={false}
      contentContainerStyle={{ paddingBottom: 40 }}
    >
      {/* ·∫¢nh b√¨a + avatar */}
      <CoverSection user={user} />

      {/* Th√¥ng tin c√° nh√¢n */}
      <View className="w-full max-w-[700px] self-center px-5">
        <InfoSection user={user} />

        {/* Tabs */}
        <ActionButtons activeTab={activeTab} onChangeTab={setActiveTab} hideFavorites={true} />

        {/* N·ªôi dung */}
        <View className="mt-8">
          {activeTab === "posts" ? (
            <MyPosts rooms={user?.publicRooms || []} />
          ) : (
            <View className="items-center mt-10">
              <Ionicons name="lock-closed-outline" size={40} color="#999" />
              <Text className="text-gray-500 mt-3 text-sm">
                Danh s√°ch ph√≤ng ƒë√£ l∆∞u ƒë∆∞·ª£c ·∫©n.
              </Text>
            </View>
          )}
        </View>
      </View>
    </Animated.ScrollView>
  );
}
